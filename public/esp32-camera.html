<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Camera Simulator | WebRTC CCTV System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #475569;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #0ea5e9;
            --light: #f8fafc;
            --dark: #0f172a;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.2s ease-in-out;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: #f1f5f9;
            color: var(--gray-800);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 1.5rem 0;
            box-shadow: var(--box-shadow);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .logo i {
            font-size: 1.75rem;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
        }

        .nav-links a {
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .nav-links a:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .card-header i {
            color: var(--primary);
            font-size: 1.25rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        label {
            font-weight: 500;
            color: var(--gray-700);
            font-size: 0.875rem;
        }

        input, select {
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-family: inherit;
            font-size: 1rem;
            transition: var(--transition);
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: var(--border-radius);
            font-family: inherit;
            font-weight: 500;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #334155;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background-color: #059669;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background-color: #dc2626;
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background-color: #d97706;
        }

        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-connected {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .status-disconnected {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .status-pending {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .video-container {
            position: relative;
            background-color: var(--gray-900);
            border-radius: var(--border-radius);
            overflow: hidden;
            aspect-ratio: 16/9;
        }

        .video-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--gray-400);
            background-color: var(--gray-800);
        }

        .video-placeholder i {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .video-placeholder p {
            text-align: center;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-card {
            background-color: var(--gray-100);
            border-radius: var(--border-radius);
            padding: 1rem;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .log-container {
            background-color: var(--gray-900);
            border-radius: var(--border-radius);
            padding: 1rem;
            height: 250px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.875rem;
            color: var(--gray-300);
        }

        .log-entry {
            margin-bottom: 0.25rem;
            word-break: break-word;
        }

        .log-timestamp {
            color: var(--gray-500);
        }

        .log-message {
            color: var(--gray-300);
        }

        footer {
            background-color: var(--gray-900);
            color: var(--gray-400);
            padding: 2rem 0;
            margin-top: 2rem;
        }

        .footer-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-camera"></i>
                    <span>ESP32 Camera Simulator</span>
                </div>
                <div class="nav-links">
                    <a href="/"><i class="fas fa-desktop"></i> Viewer</a>
                    <a href="/esp32-camera.html"><i class="fas fa-camera"></i> Camera Simulator</a>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-info-circle"></i>
                <h2 class="card-title">System Overview</h2>
            </div>
            <p>This simulator emulates an ESP32 camera device that connects to the WebRTC signaling server. It registers with a unique camera ID and waits for viewer requests to start streaming video.</p>
        </div>

        <div class="controls-grid">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-door-open"></i>
                    <h2 class="card-title">Room Management</h2>
                </div>
                <div class="control-group">
                    <div class="form-group">
                        <label for="roomNameInput">Room Name</label>
                        <input type="text" id="roomNameInput" placeholder="Enter room name" value="cctv">
                    </div>
                    <div class="btn-group">
                        <button id="joinRoomBtn" class="btn btn-primary">
                            <i class="fas fa-sign-in-alt"></i> Join Room
                        </button>
                        <button id="leaveRoomBtn" class="btn btn-secondary" disabled>
                            <i class="fas fa-sign-out-alt"></i> Leave Room
                        </button>
                    </div>
                    <div style="margin-top: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <span>Current Room:</span>
                        <span id="currentRoom" class="status-indicator status-disconnected">Not in a room</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="fas fa-cog"></i>
                    <h2 class="card-title">Camera Configuration</h2>
                </div>
                <div class="control-group">
                    <div class="form-group">
                        <label for="cameraIdInput">Camera ID</label>
                        <input type="text" id="cameraIdInput" placeholder="Enter Camera ID" value="ESP32-SIM-001">
                    </div>
                    <div class="btn-group">
                        <button id="connectBtn" class="btn btn-success">
                            <i class="fas fa-plug"></i> Connect Camera
                        </button>
                        <button id="disconnectBtn" class="btn btn-danger" disabled>
                            <i class="fas fa-power-off"></i> Disconnect
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <i class="fas fa-video"></i>
                <h2 class="card-title">Camera Preview</h2>
            </div>
            <div class="video-container">
                <video id="localVideo" autoplay muted></video>
                <div id="videoPlaceholder" class="video-placeholder">
                    <div>
                        <i class="fas fa-video-slash"></i>
                        <p>Camera feed will appear here after connecting</p>
                    </div>
                </div>
            </div>
            <div class="btn-group" style="margin-top: 1.5rem;">
                <button id="startStreamBtn" class="btn btn-primary" disabled>
                    <i class="fas fa-play"></i> Start Streaming
                </button>
                <button id="stopStreamBtn" class="btn btn-danger" disabled>
                    <i class="fas fa-stop"></i> Stop Streaming
                </button>
            </div>
        </div>

        <div class="controls-grid">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-bar"></i>
                    <h2 class="card-title">Connection Status</h2>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="viewerCount">0</div>
                        <div class="stat-label">Connected Viewers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="streamingStatusValue">Off</div>
                        <div class="stat-label">Streaming Status</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="connectionStatusValue">Disconnected</div>
                        <div class="stat-label">Server Connection</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="fas fa-terminal"></i>
                    <h2 class="card-title">System Log</h2>
                </div>
                <div class="log-container" id="log">
                    <div class="log-entry">
                        <span class="log-timestamp">[--:--:--]</span>
                        <span class="log-message">System initialized. Ready to connect camera.</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <p>WebRTC CCTV System &copy; 2025 | Enterprise Video Streaming Solution</p>
                <p>Secure, scalable, and real-time video monitoring</p>
            </div>
        </div>
    </footer>

    <script>
        // DOM elements
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const startStreamBtn = document.getElementById('startStreamBtn');
        const stopStreamBtn = document.getElementById('stopStreamBtn');
        const cameraIdInput = document.getElementById('cameraIdInput');
        const roomNameInput = document.getElementById('roomNameInput');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        const leaveRoomBtn = document.getElementById('leaveRoomBtn');
        const currentRoomSpan = document.getElementById('currentRoom');
        const localVideo = document.getElementById('localVideo');
        const videoPlaceholder = document.getElementById('videoPlaceholder');
        const viewerCountSpan = document.getElementById('viewerCount');
        const streamingStatusValue = document.getElementById('streamingStatusValue');
        const connectionStatusValue = document.getElementById('connectionStatusValue');
        const logDiv = document.getElementById('log');
        
        // Variables
        let ws;
        let clientId;
        let cameraId;
        let localStream;
        let peerConnections = new Map();
        let viewerCount = 0;
        let isStreaming = false;
        let currentRoom = null;
        
        // Configuration
        const config = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };
        
        // Log function
        function log(message) {
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="log-timestamp">[${time}]</span> <span class="log-message">${message}</span>`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        // Update UI status indicators
        function updateStatusIndicators() {
            // Update room status
            if (currentRoom) {
                currentRoomSpan.textContent = currentRoom;
                currentRoomSpan.className = 'status-indicator status-connected';
            } else {
                currentRoomSpan.textContent = 'Not in a room';
                currentRoomSpan.className = 'status-indicator status-disconnected';
            }
            
            // Update streaming status
            if (isStreaming) {
                streamingStatusValue.textContent = 'Active';
                streamingStatusValue.style.color = 'var(--success)';
            } else {
                streamingStatusValue.textContent = 'Off';
                streamingStatusValue.style.color = 'var(--danger)';
            }
            
            // Update connection status
            if (ws && ws.readyState === WebSocket.OPEN) {
                connectionStatusValue.textContent = 'Connected';
                connectionStatusValue.style.color = 'var(--success)';
            } else {
                connectionStatusValue.textContent = 'Disconnected';
                connectionStatusValue.style.color = 'var(--danger)';
            }
        }
        
        // Connect to signaling server as camera
        connectBtn.onclick = async () => {
            cameraId = cameraIdInput.value.trim();
            if (!cameraId) {
                log('Error: Please enter a camera ID');
                return;
            }
            
            try {
                // Get local media stream
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: false 
                });
                localVideo.srcObject = localStream;
                videoPlaceholder.style.display = 'none';
                log('Local video stream acquired');
            } catch (error) {
                log(`Error accessing media devices: ${error}`);
                alert('Could not access camera. Please ensure you have a camera connected and have granted permission.');
                return;
            }
            
            const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            const wsUrl = protocol + window.location.host;
            
            log(`Connecting to signaling server at ${wsUrl} as camera ${cameraId}`);
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                log('Connected to signaling server');
                updateStatusIndicators();
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                joinRoomBtn.disabled = false;
            };
            
            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                log(`Received: ${message.type}`);
                
                switch (message.type) {
                    case 'welcome':
                        clientId = message.clientId;
                        log(`Assigned client ID: ${clientId}`);
                        break;
                        
                    case 'joined':
                        currentRoom = message.room;
                        log(`Joined room: ${message.room}`);
                        updateStatusIndicators();
                        startStreamBtn.disabled = false;
                        leaveRoomBtn.disabled = false;
                        break;
                        
                    case 'clientJoined':
                        log(`Client ${message.clientId} joined the room (${message.deviceType})`);
                        break;
                        
                    case 'viewerRequest':
                        log(`Viewer ${message.viewerId} requested stream`);
                        handleViewerRequest(message);
                        break;
                        
                    case 'offer':
                        handleOffer(message);
                        break;
                        
                    case 'answer':
                        handleAnswer(message);
                        break;
                        
                    case 'iceCandidate':
                        handleIceCandidate(message);
                        break;
                        
                    default:
                        log(`Unknown message type: ${message.type}`);
                }
            };

            ws.onclose = () => {
                log('Disconnected from signaling server');
                updateStatusIndicators();
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                startStreamBtn.disabled = true;
                stopStreamBtn.disabled = true;
                joinRoomBtn.disabled = true;
                leaveRoomBtn.disabled = true;
                currentRoom = null;
                
                // Close all peer connections
                peerConnections.forEach(pc => pc.close());
                peerConnections.clear();
                viewerCount = 0;
                viewerCountSpan.textContent = viewerCount;
                
                // Stop local stream
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                    localVideo.srcObject = null;
                    videoPlaceholder.style.display = 'flex';
                }
                
                updateStatusIndicators();
            };
            
            ws.onerror = (error) => {
                log(`WebSocket error: ${error}`);
            };
        };
        
        // Disconnect from server
        disconnectBtn.onclick = () => {
            if (ws) {
                ws.close();
            }
        };
        
        // Join room
        joinRoomBtn.onclick = () => {
            const roomName = roomNameInput.value.trim();
            if (!roomName) {
                log('Error: Please enter a room name');
                return;
            }
            
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('Error: Not connected to server');
                return;
            }
            
            // Leave current room if in one
            if (currentRoom) {
                log(`Leaving room ${currentRoom}`);
            }
            
            // Join new room
            log(`Joining room: ${roomName}`);
            ws.send(JSON.stringify({
                type: 'join',
                room: roomName,
                deviceType: 'camera',
                cameraId: cameraId
            }));
        };
        
        // Leave current room
        leaveRoomBtn.onclick = () => {
            if (!currentRoom) {
                log('Error: Not in a room');
                return;
            }
            
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('Error: Not connected to server');
                return;
            }
            
            // Close all peer connections
            peerConnections.forEach(pc => pc.close());
            peerConnections.clear();
            viewerCount = 0;
            viewerCountSpan.textContent = viewerCount;
            
            // Leave room by joining default room
            log(`Leaving room ${currentRoom}`);
            ws.send(JSON.stringify({
                type: 'join',
                room: 'default',
                deviceType: 'camera',
                cameraId: cameraId
            }));
            
            currentRoom = null;
            updateStatusIndicators();
            startStreamBtn.disabled = true;
            stopStreamBtn.disabled = true;
            leaveRoomBtn.disabled = true;
        };
        
        // Start streaming (manual mode)
        startStreamBtn.onclick = () => {
            isStreaming = true;
            updateStatusIndicators();
            startStreamBtn.disabled = true;
            stopStreamBtn.disabled = false;
            log('Manual streaming started');
        };
        
        // Stop streaming
        stopStreamBtn.onclick = () => {
            isStreaming = false;
            updateStatusIndicators();
            startStreamBtn.disabled = false;
            stopStreamBtn.disabled = true;
            
            // Close all peer connections
            peerConnections.forEach(pc => pc.close());
            peerConnections.clear();
            viewerCount = 0;
            viewerCountSpan.textContent = viewerCount;
            
            log('Streaming stopped');
        };
        
        // Handle viewer request for stream
        function handleViewerRequest(message) {
            if (!isStreaming) {
                log(`Viewer ${message.viewerId} requested stream, but streaming is not enabled`);
                return;
            }
            
            log(`Creating connection for viewer ${message.viewerId}`);
            viewerCount++;
            viewerCountSpan.textContent = viewerCount;
            updateStatusIndicators();
            
            createPeerConnection(message.viewerId);
            createOffer(message.viewerId);
        }
        
        // Create peer connection
        function createPeerConnection(viewerId) {
            const peerConnection = new RTCPeerConnection(config);
            
            // Add media tracks (video only for CCTV)
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
            }
            
            // Handle ICE candidates
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    log(`Sending ICE candidate to viewer ${viewerId}`);
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'iceCandidate',
                            target: viewerId,
                            candidate: event.candidate
                        }));
                    }
                }
            };
            
            // Handle connection state changes
            peerConnection.onconnectionstatechange = () => {
                log(`Connection state with viewer ${viewerId}: ${peerConnection.connectionState}`);
                if (peerConnection.connectionState === 'disconnected' || 
                    peerConnection.connectionState === 'failed') {
                    peerConnections.delete(viewerId);
                    viewerCount = Math.max(0, viewerCount - 1);
                    viewerCountSpan.textContent = viewerCount;
                    updateStatusIndicators();
                }
            };
            
            // Store peer connection
            peerConnections.set(viewerId, peerConnection);
            return peerConnection;
        }
        
        // Create offer
        async function createOffer(viewerId) {
            try {
                const peerConnection = peerConnections.get(viewerId);
                if (!peerConnection) return;
                
                const offer = await peerConnection.createOffer({
                    offerToReceiveVideo: false, // Camera sends video, doesn't receive
                    offerToReceiveAudio: false
                });
                
                await peerConnection.setLocalDescription(offer);
                
                log(`Sending offer to viewer ${viewerId}`);
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'offer',
                        target: viewerId,
                        sdp: offer
                    }));
                }
            } catch (error) {
                log(`Error creating offer: ${error}`);
            }
        }
        
        // Handle offer from viewer (shouldn't happen in this architecture)
        async function handleOffer(message) {
            try {
                log(`Received unexpected offer from viewer ${message.sender}`);
                
                let peerConnection;
                if (peerConnections.has(message.sender)) {
                    peerConnection = peerConnections.get(message.sender);
                } else {
                    peerConnection = createPeerConnection(message.sender);
                }
                
                await peerConnection.setRemoteDescription(new RTCSessionDescription(message.sdp));
                
                const answer = await peerConnection.createAnswer({
                    offerToReceiveVideo: false,
                    offerToReceiveAudio: false
                });
                
                await peerConnection.setLocalDescription(answer);
                
                log(`Sending answer to viewer ${message.sender}`);
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'answer',
                        target: message.sender,
                        sdp: answer
                    }));
                }
            } catch (error) {
                log(`Error handling offer: ${error}`);
            }
        }
        
        // Handle answer from viewer
        async function handleAnswer(message) {
            try {
                log(`Received answer from viewer ${message.sender}`);
                const peerConnection = peerConnections.get(message.sender);
                if (!peerConnection) {
                    log(`No peer connection found for viewer ${message.sender}`);
                    return;
                }
                
                await peerConnection.setRemoteDescription(new RTCSessionDescription(message.sdp));
            } catch (error) {
                log(`Error handling answer: ${error}`);
            }
        }
        
        // Handle ICE candidate from viewer
        async function handleIceCandidate(message) {
            try {
                log(`Received ICE candidate from viewer ${message.sender}`);
                const peerConnection = peerConnections.get(message.sender);
                if (!peerConnection) {
                    log(`No peer connection found for viewer ${message.sender}`);
                    return;
                }
                
                await peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate));
            } catch (error) {
                log(`Error handling ICE candidate: ${error}`);
            }
        }
        
        // Initialize
        updateStatusIndicators();
    </script>
</body>
</html>