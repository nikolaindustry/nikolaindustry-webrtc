<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nikolaindustry-webrtc Viewer | Enterprise Video Monitoring</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #475569;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #0ea5e9;
            --light: #f8fafc;
            --dark: #0f172a;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.2s ease-in-out;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: #f1f5f9;
            color: var(--gray-800);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 1.5rem 0;
            box-shadow: var(--box-shadow);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .logo i {
            font-size: 1.75rem;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
        }

        .nav-links a {
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .nav-links a:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .card-header i {
            color: var(--primary);
            font-size: 1.25rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        label {
            font-weight: 500;
            color: var(--gray-700);
            font-size: 0.875rem;
        }

        input, select {
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-family: inherit;
            font-size: 1rem;
            transition: var(--transition);
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: var(--border-radius);
            font-family: inherit;
            font-weight: 500;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #334155;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background-color: #059669;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background-color: #dc2626;
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background-color: #d97706;
        }

        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-connected {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .status-disconnected {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .status-pending {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .video-container {
            position: relative;
            background-color: var(--gray-900);
            border-radius: var(--border-radius);
            overflow: hidden;
            aspect-ratio: 16/9;
        }

        .video-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--gray-400);
            background-color: var(--gray-800);
        }

        .video-placeholder i {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .video-placeholder p {
            text-align: center;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }

        .camera-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: var(--gray-100);
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .camera-item:hover {
            background-color: var(--gray-200);
        }

        .camera-id {
            font-weight: 500;
            color: var(--gray-800);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-card {
            background-color: var(--gray-100);
            border-radius: var(--border-radius);
            padding: 1rem;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .log-container {
            background-color: var(--gray-900);
            border-radius: var(--border-radius);
            padding: 1rem;
            height: 250px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.875rem;
            color: var(--gray-300);
        }

        .log-entry {
            margin-bottom: 0.25rem;
            word-break: break-word;
        }

        .log-timestamp {
            color: var(--gray-500);
        }

        .log-message {
            color: var(--gray-300);
        }

        footer {
            background-color: var(--gray-900);
            color: var(--gray-400);
            padding: 2rem 0;
            margin-top: 2rem;
        }

        .footer-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .video-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-desktop"></i>
                    <span>nikolaindustry-webrtc Viewer</span>
                </div>
                <div class="nav-links">
                    <a href="/"><i class="fas fa-desktop"></i> Viewer</a>
                    <a href="/camera-simulator.html"><i class="fas fa-camera"></i> Camera Simulator</a>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-info-circle"></i>
                <h2 class="card-title">System Overview</h2>
            </div>
            <p>Connect to view live footage from ESP32 cameras. Join a room to see available cameras, then request to view specific camera feeds by their ID.</p>
        </div>

        <div class="controls-grid">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-server"></i>
                    <h2 class="card-title">Server Connection</h2>
                </div>
                <div class="control-group">
                    <div class="btn-group">
                        <button id="connectBtn" class="btn btn-success">
                            <i class="fas fa-plug"></i> Connect to Server
                        </button>
                        <button id="disconnectBtn" class="btn btn-danger" disabled>
                            <i class="fas fa-power-off"></i> Disconnect
                        </button>
                    </div>
                    <div style="margin-top: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <span>Server Status:</span>
                        <span id="serverStatus" class="status-indicator status-disconnected">Disconnected</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="fas fa-door-open"></i>
                    <h2 class="card-title">Room Management</h2>
                </div>
                <div class="control-group">
                    <div class="form-group">
                        <label for="roomNameInput">Room Name</label>
                        <input type="text" id="roomNameInput" placeholder="Enter room name" value="cctv">
                    </div>
                    <div class="btn-group">
                        <button id="createRoomBtn" class="btn btn-primary" disabled>
                            <i class="fas fa-sign-in-alt"></i> Create/Join Room
                        </button>
                        <button id="leaveRoomBtn" class="btn btn-secondary" disabled>
                            <i class="fas fa-sign-out-alt"></i> Leave Room
                        </button>
                    </div>
                    <div style="margin-top: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <span>Current Room:</span>
                        <span id="currentRoom" class="status-indicator status-disconnected">Not in a room</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <i class="fas fa-video"></i>
                <h2 class="card-title">Camera Control</h2>
            </div>
            <div class="control-group">
                <div class="form-group">
                    <label for="cameraIdInput">Camera ID</label>
                    <input type="text" id="cameraIdInput" placeholder="Enter Camera ID to view">
                </div>
                <div class="btn-group">
                    <button id="viewBtn" class="btn btn-primary" disabled>
                        <i class="fas fa-eye"></i> View Camera
                    </button>
                    <button id="refreshBtn" class="btn btn-secondary" disabled>
                        <i class="fas fa-sync-alt"></i> Refresh Camera List
                    </button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <i class="fas fa-list"></i>
                <h2 class="card-title">Available Cameras</h2>
            </div>
            <div id="camerasList">
                <p>No cameras available. Connect cameras to the network.</p>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <i class="fas fa-th-large"></i>
                <h2 class="card-title">Active Video Streams</h2>
            </div>
            <div class="video-grid" id="videoContainer">
                <div class="video-placeholder">
                    <div>
                        <i class="fas fa-video-slash"></i>
                        <p>Active video streams will appear here</p>
                    </div>
                </div>
            </div>
            <div class="btn-group" style="margin-top: 1rem;">
                <button id="micToggleButton" class="btn btn-secondary">
                    <i class="fas fa-microphone"></i> Mute Audio
                </button>
            </div>
        </div>

        <div class="controls-grid">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-bar"></i>
                    <h2 class="card-title">Connection Status</h2>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="activeStreamsCount">0</div>
                        <div class="stat-label">Active Streams</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="availableCamerasCount">0</div>
                        <div class="stat-label">Available Cameras</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="connectionStatusValue">Disconnected</div>
                        <div class="stat-label">Server Connection</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="fas fa-terminal"></i>
                    <h2 class="card-title">System Log</h2>
                </div>
                <div class="log-container" id="log">
                    <div class="log-entry">
                        <span class="log-timestamp">[--:--:--]</span>
                        <span class="log-message">System initialized. Ready to connect to server.</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <p>WebRTC CCTV System &copy; 2025 | Enterprise Video Streaming Solution</p>
                <p>Secure, scalable, and real-time video monitoring</p>
            </div>
        </div>
    </footer>

    <script>
        // DOM elements
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const viewBtn = document.getElementById('viewBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const micToggleButton = document.getElementById('micToggleButton'); // Add mic toggle button
        const cameraIdInput = document.getElementById('cameraIdInput');
        const roomNameInput = document.getElementById('roomNameInput');
        const createRoomBtn = document.getElementById('createRoomBtn');
        const leaveRoomBtn = document.getElementById('leaveRoomBtn');
        const currentRoomSpan = document.getElementById('currentRoom');
        const serverStatusSpan = document.getElementById('serverStatus');
        const camerasList = document.getElementById('camerasList');
        const videoContainer = document.getElementById('videoContainer');
        const logDiv = document.getElementById('log');
        const activeStreamsCount = document.getElementById('activeStreamsCount');
        const availableCamerasCount = document.getElementById('availableCamerasCount');
        const connectionStatusValue = document.getElementById('connectionStatusValue');
        
        // Variables
        let ws;
        let clientId;
        let currentRoom = null;
        let availableCameras = new Map();
        let activeStreams = new Map();
        let peerConnections = new Map();
        let isAudioMuted = false; // Add audio muted state
        
        // Configuration
        const config = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };
        
        // Log function
        function log(message) {
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="log-timestamp">[${time}]</span> <span class="log-message">${message}</span>`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        // Update UI status indicators
        function updateStatusIndicators() {
            // Update room status
            if (currentRoom) {
                currentRoomSpan.textContent = currentRoom;
                currentRoomSpan.className = 'status-indicator status-connected';
            } else {
                currentRoomSpan.textContent = 'Not in a room';
                currentRoomSpan.className = 'status-indicator status-disconnected';
            }
            
            // Update server status
            if (ws && ws.readyState === WebSocket.OPEN) {
                serverStatusSpan.textContent = 'Connected';
                serverStatusSpan.className = 'status-indicator status-connected';
                connectionStatusValue.textContent = 'Connected';
                connectionStatusValue.style.color = 'var(--success)';
            } else {
                serverStatusSpan.textContent = 'Disconnected';
                serverStatusSpan.className = 'status-indicator status-disconnected';
                connectionStatusValue.textContent = 'Disconnected';
                connectionStatusValue.style.color = 'var(--danger)';
            }
            
            // Update stats
            activeStreamsCount.textContent = activeStreams.size;
            availableCamerasCount.textContent = availableCameras.size;
        }
        
        // Connect to signaling server
        connectBtn.onclick = () => {
            const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            const wsUrl = protocol + window.location.host;
            
            log(`Connecting to signaling server at ${wsUrl}`);
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                log('Connected to signaling server');
                updateStatusIndicators();
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                createRoomBtn.disabled = false;
                micToggleButton.disabled = false; // Enable mic toggle button
            };
            
            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                log(`Received: ${message.type}`);
                
                switch (message.type) {
                    case 'welcome':
                        clientId = message.clientId;
                        log(`Assigned client ID: ${clientId}`);
                        break;
                        
                    case 'joined':
                        currentRoom = message.room;
                        log(`Joined room: ${message.room}`);
                        updateStatusIndicators();
                        viewBtn.disabled = false;
                        refreshBtn.disabled = false;
                        leaveRoomBtn.disabled = false;
                        break;
                        
                    case 'offer':
                        handleOffer(message);
                        break;
                        
                    case 'answer':
                        handleAnswer(message);
                        break;
                        
                    case 'iceCandidate':
                        handleIceCandidate(message);
                        break;
                        
                    case 'clientJoined':
                        log(`Client ${message.clientId} joined the room (${message.deviceType})`);
                        break;
                        
                    case 'cameraAvailable':
                        log(`Camera ${message.cameraId} is now available`);
                        availableCameras.set(message.cameraId, message.clientId);
                        updateCamerasList();
                        updateStatusIndicators();
                        break;
                        
                    case 'cameraUnavailable':
                        log(`Camera ${message.cameraId} is no longer available`);
                        availableCameras.delete(message.cameraId);
                        updateCamerasList();
                        updateStatusIndicators();
                        break;
                        
                    case 'cameraNotFound':
                        log(`Camera ${message.cameraId} not found`);
                        alert(`Camera ${message.cameraId} is not currently available`);
                        break;
                        
                    default:
                        log(`Unknown message type: ${message.type}`);
                }
            };
            
            ws.onclose = () => {
                log('Disconnected from signaling server');
                updateStatusIndicators();
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                viewBtn.disabled = true;
                refreshBtn.disabled = true;
                createRoomBtn.disabled = true;
                leaveRoomBtn.disabled = true;
                currentRoom = null;
                
                // Clear all active streams
                activeStreams.forEach((stream, cameraId) => {
                    stream.getTracks().forEach(track => track.stop());
                });
                activeStreams.clear();
                
                // Close all peer connections
                peerConnections.forEach(pc => pc.close());
                peerConnections.clear();
                
                // Clear UI
                videoContainer.innerHTML = `
                    <div class="video-placeholder">
                        <div>
                            <i class="fas fa-video-slash"></i>
                            <p>Active video streams will appear here</p>
                        </div>
                    </div>
                `;
                
                updateStatusIndicators();
            };
            
            ws.onerror = (error) => {
                log(`WebSocket error: ${error}`);
            };
        };
        
        // Disconnect from server
        disconnectBtn.onclick = () => {
            if (ws) {
                ws.close();
            }
        };
        
        // Create or join room
        createRoomBtn.onclick = () => {
            const roomName = roomNameInput.value.trim();
            if (!roomName) {
                log('Error: Please enter a room name');
                return;
            }
            
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('Error: Not connected to server');
                return;
            }
            
            // Leave current room if in one
            if (currentRoom) {
                log(`Leaving room ${currentRoom}`);
            }
            
            // Clear current camera list
            availableCameras.clear();
            updateCamerasList();
            
            // Join new room
            log(`Joining room: ${roomName}`);
            ws.send(JSON.stringify({
                type: 'join',
                room: roomName
                // Viewers don't need to specify deviceType, it defaults to 'viewer'
            }));
        };
        
        // Leave current room
        leaveRoomBtn.onclick = () => {
            if (!currentRoom) {
                log('Error: Not in a room');
                return;
            }
            
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('Error: Not connected to server');
                return;
            }
            
            // Clear current camera list
            availableCameras.clear();
            updateCamerasList();
            
            // Leave room by joining default room
            log(`Leaving room ${currentRoom}`);
            ws.send(JSON.stringify({
                type: 'join',
                room: 'default'
            }));
            
            currentRoom = null;
            updateStatusIndicators();
            viewBtn.disabled = true;
            refreshBtn.disabled = true;
            leaveRoomBtn.disabled = true;
        };
        
        // View a specific camera
        viewBtn.onclick = () => {
            const cameraId = cameraIdInput.value.trim();
            if (!cameraId) {
                log('Error: Please enter a camera ID');
                return;
            }
            
            if (!currentRoom) {
                log('Error: Please join a room first');
                return;
            }
            
            if (availableCameras.has(cameraId)) {
                requestCameraStream(cameraId);
            } else {
                // Request stream anyway - server will check if camera exists
                requestCameraStream(cameraId);
            }
        };
        
        // Refresh camera list
        refreshBtn.onclick = () => {
            if (!currentRoom) {
                log('Error: Not in a room');
                return;
            }
            
            // Request updated camera list from server
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'join',
                    room: currentRoom
                }));
                log('Refreshing camera list...');
            }
        };
        
        // Request camera stream
        function requestCameraStream(cameraId) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('Error: Not connected to server');
                return;
            }
            
            if (!currentRoom) {
                log('Error: Not in a room');
                return;
            }
            
            log(`Requesting stream from camera ${cameraId} in room ${currentRoom}`);
            ws.send(JSON.stringify({
                type: 'requestStream',
                cameraId: cameraId,
                requestId: Date.now().toString()
            }));
            
            // Pre-create peer connection for this camera using cameraId as key
            if (!peerConnections.has(cameraId)) {
                createPeerConnection(cameraId);
            }
        }
        
        // Update cameras list UI
        function updateCamerasList() {
            if (availableCameras.size === 0) {
                camerasList.innerHTML = '<p>No cameras available. Connect cameras to the network.</p>';
                return;
            }
            
            let html = '<div class="camera-list">';
            availableCameras.forEach((clientId, cameraId) => {
                html += `
                    <div class="camera-item">
                        <span class="camera-id">Camera ${cameraId}</span>
                        <button class="btn btn-primary btn-sm" onclick="requestCameraStream('${cameraId}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </div>
                `;
            });
            html += '</div>';
            camerasList.innerHTML = html;
        }
        
        // Create peer connection
        function createPeerConnection(cameraId) {
            const peerConnection = new RTCPeerConnection(config);
            
            // Handle ICE candidates
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    log(`Sending ICE candidate to camera ${cameraId}`);
                    // Find the client ID for this camera
                    let targetClientId = null;
                    availableCameras.forEach((clientId, id) => {
                        if (id === cameraId) {
                            targetClientId = clientId;
                        }
                    });
                    
                    if (targetClientId && ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'iceCandidate',
                            target: targetClientId,
                            candidate: event.candidate
                        }));
                    }
                }
            };
            
            // Handle remote stream
            peerConnection.ontrack = (event) => {
                log(`Received video stream from camera ${cameraId}`);
                const stream = event.streams[0];
                activeStreams.set(cameraId, stream);
                displayVideoStream(cameraId, stream);
                updateStatusIndicators();
            };
            
            // Handle connection state changes
            peerConnection.onconnectionstatechange = () => {
                log(`Connection state with camera ${cameraId}: ${peerConnection.connectionState}`);
                if (peerConnection.connectionState === 'disconnected' || 
                    peerConnection.connectionState === 'failed') {
                    peerConnections.delete(cameraId);
                    if (activeStreams.has(cameraId)) {
                        activeStreams.delete(cameraId);
                        updateStatusIndicators();
                    }
                }
            };
            
            peerConnection.onsignalingstatechange = () => {
                log(`Signaling state with camera ${cameraId}: ${peerConnection.signalingState}`);
            };
            
            peerConnection.oniceconnectionstatechange = () => {
                log(`ICE connection state with camera ${cameraId}: ${peerConnection.iceConnectionState}`);
            };
            
            // Store the peer connection
            peerConnections.set(cameraId, peerConnection);
            return peerConnection;
        }
        
        // Display video stream in UI
        function displayVideoStream(cameraId, stream) {
            // Remove placeholder if it exists
            const placeholder = videoContainer.querySelector('.video-placeholder');
            if (placeholder) {
                videoContainer.innerHTML = '';
            }
            
            // Check if video element already exists
            let videoContainerEl = document.getElementById(`video-${cameraId}`);
            if (!videoContainerEl) {
                videoContainerEl = document.createElement('div');
                videoContainerEl.id = `video-${cameraId}`;
                videoContainerEl.className = 'video-container';
                videoContainerEl.innerHTML = `
                    <video id="video-${cameraId}-player" autoplay></video>
                    <div style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.875rem;">
                        Camera ${cameraId}
                    </div>
                    <button class="btn btn-danger" style="position: absolute; top: 10px; right: 10px; padding: 5px 10px;" onclick="stopCameraStream('${cameraId}')">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                videoContainer.appendChild(videoContainerEl);
            }
            
            const videoElement = document.getElementById(`video-${cameraId}-player`);
            videoElement.srcObject = stream;
        }
        
        // Stop viewing a camera
        function stopCameraStream(cameraId) {
            // Close peer connection
            if (peerConnections.has(cameraId)) {
                peerConnections.get(cameraId).close();
                peerConnections.delete(cameraId);
            }
            
            // Stop stream tracks
            if (activeStreams.has(cameraId)) {
                activeStreams.get(cameraId).getTracks().forEach(track => track.stop());
                activeStreams.delete(cameraId);
            }
            
            // Remove video element
            const videoContainerEl = document.getElementById(`video-${cameraId}`);
            if (videoContainerEl) {
                videoContainerEl.remove();
            }
            
            // Show placeholder if no streams
            if (activeStreams.size === 0) {
                videoContainer.innerHTML = `
                    <div class="video-placeholder">
                        <div>
                            <i class="fas fa-video-slash"></i>
                            <p>Active video streams will appear here</p>
                        </div>
                    </div>
                `;
            }
            
            log(`Stopped viewing camera ${cameraId}`);
            updateStatusIndicators();
        }
        
        // Handle offer from camera
        async function handleOffer(message) {
            try {
                log(`Received offer from camera ${message.sender}`);
                
                // Find the cameraId for this sender
                let cameraId = null;
                availableCameras.forEach((clientId, id) => {
                    if (clientId === message.sender) {
                        cameraId = id;
                    }
                });
                
                if (!cameraId) {
                    log(`Could not find camera ID for sender ${message.sender}`);
                    return;
                }
                
                // Get or create peer connection for this camera
                let peerConnection;
                if (!peerConnections.has(cameraId)) {
                    peerConnection = createPeerConnection(cameraId);
                } else {
                    peerConnection = peerConnections.get(cameraId);
                }
                
                await peerConnection.setRemoteDescription(new RTCSessionDescription(message.sdp));
                
                log(`Creating answer for camera ${cameraId}`);
                const answer = await peerConnection.createAnswer({
                    offerToReceiveVideo: true,
                    offerToReceiveAudio: true
                });
                
                await peerConnection.setLocalDescription(answer);
                
                log(`Sending answer to camera ${message.sender}`);
                ws.send(JSON.stringify({
                    type: 'answer',
                    target: message.sender,
                    sdp: answer
                }));
            } catch (error) {
                log(`Error handling offer from camera ${message.sender}: ${error}`);
            }
        }
        
        // Handle answer from camera
        async function handleAnswer(message) {
            try {
                log(`Received answer from camera ${message.sender}`);
                // Find the cameraId for this sender
                let cameraId = null;
                availableCameras.forEach((clientId, id) => {
                    if (clientId === message.sender) {
                        cameraId = id;
                    }
                });
                
                if (!cameraId) {
                    log(`Could not find camera ID for sender ${message.sender}`);
                    return;
                }
                
                const peerConnection = peerConnections.get(cameraId);
                if (!peerConnection) {
                    log(`No peer connection found for camera ${cameraId}`);
                    return;
                }
                
                await peerConnection.setRemoteDescription(new RTCSessionDescription(message.sdp));
            } catch (error) {
                log(`Error handling answer from camera ${message.sender}: ${error}`);
            }
        }
        
        // Handle ICE candidate from camera
        async function handleIceCandidate(message) {
            try {
                log(`Received ICE candidate from camera ${message.sender}`);
                
                // Find the cameraId for this sender
                let cameraId = null;
                availableCameras.forEach((clientId, id) => {
                    if (clientId === message.sender) {
                        cameraId = id;
                    }
                });
                
                if (!cameraId) {
                    log(`Could not find camera ID for sender ${message.sender}`);
                    return;
                }
                
                const peerConnection = peerConnections.get(cameraId);
                if (!peerConnection) {
                    log(`No peer connection found for camera ${cameraId}`);
                    return;
                }
                
                await peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate));
            } catch (error) {
                log(`Error handling ICE candidate from camera ${message.sender}: ${error}`);
            }
        }
        
        // Toggle microphone/audio
        micToggleButton.onclick = () => {
            isAudioMuted = !isAudioMuted;
            
            if (isAudioMuted) {
                micToggleButton.innerHTML = '<i class="fas fa-microphone-slash"></i> Unmute Audio';
                micToggleButton.classList.remove('btn-secondary');
                micToggleButton.classList.add('btn-warning');
                log('Audio muted');
            } else {
                micToggleButton.innerHTML = '<i class="fas fa-microphone"></i> Mute Audio';
                micToggleButton.classList.remove('btn-warning');
                micToggleButton.classList.add('btn-secondary');
                log('Audio unmuted');
            }
            
            // Update audio state for all existing peer connections
            activeStreams.forEach((stream, cameraId) => {
                const videoElement = document.getElementById(`video-${cameraId}`);
                if (videoElement && videoElement.srcObject) {
                    const audioTracks = videoElement.srcObject.getAudioTracks();
                    audioTracks.forEach(track => {
                        track.enabled = !isAudioMuted;
                    });
                }
            });
        };
        
        // Make functions available globally for inline event handlers
        window.requestCameraStream = requestCameraStream;
        window.stopCameraStream = stopCameraStream;
        
        // Initialize
        updateStatusIndicators();
    </script>
</body>
</html>